import requests
from lxml import etree

from tool import getAlbumInfo
from f1 import getAlbumRetentionRate

# 爬取专辑页类似：
# https://www.ximalaya.com/category/a3_b10880_c1433/
# https://www.ximalaya.com/category/a3_b10880_c1433/p2/
# https://www.ximalaya.com/category/a3_b10880_c1433/p3/
# 至少有50页
# 在页面里找到xpath为：'//li[@class = '_ZV']//div[@class = 'album-wrapper-card T_G']//@href'
# 得到的结果是类似‘/album/75449650’,需要处理一下，得到‘75449650’
# 每一页应该有56个结果，但是最后一页不一定有56个结果

# ablum_ids1 = [34220825,61310701,8695127,75919402,37081450,26085992,51079830,9724463,51626147,14356532,15828621,70969830,12840710,26711700,3011755,4137349,60639121,75920171,57319414,47132142,69706670,3290982,51398953,20047196,54050594,30788238,21981646,18368568,29316562,28731925,55149881,13617430,11469973,24619805,18057491,39714112,12214403,2949823,70481640,73170318,69801677,36096442,57065461,75172083,71331388,28760685,68216490,60639769,20133661,75885102,47410676,76058056,52328089,49405823,2879299,11436346]
# ablum_ids2 = [65848442,70965080,75115229,71978389,71367410,24873849,64789616,67844532,23875053,6142095,50716182,3070943,33920963,70522857,69856043,11334318,39820880,74338866,51886654,20134188,54989773,49383263,74788321,54152363,71615281,56466070,45099200,5101446,15385624,13328902,63638584,57062331,6408451,2910083,52626062,51078900,58160236,42467704,48181930,3057947,16765936,53768549,44549805,71664965,21406206,76803582,73454475,7952590,71592768,14471827,64773666,68183468,4614426,26764200,54076235,48373328]


ablum_ids1 = [4756811,47517749,32650457,12642314,3160816,16411402,26438796,33476331,25010802,23034547,12169061,22129475,3071659,14868992,44741345,2684034,34220825,8695127,12296837,4615999,19095902,2897626,11715234,23457286,10587045,26478515,47040298,4137349,55045267,54079726,9724463,19326274,3416829,68525535,18445821,11813511,2991915,20459292,8625924,6628920,12610571,31887842,2910554,69486129,29316562,22216262,71143288,31503620,13507836,2909714,13551612,45410971,18372779,3071669,22162462,2912127,24995314,2799378,51079830,43683039,45161019,15754813,36154122,17594210,3290982,3780165,41152884,50069461,3803694,5133474,12415843,38829715,10691273,16636827,18708241,54079667,31667632,13180603,259426,41719872,15338164,48079933,20078875,52465976,12196601,15685983,19538531,52406969,37712781,3161070,25455385,10419197,23818706,3581543,26711700,57141014,3011755,14849828,33704383,49964515,11346422,40329059,11679544,74119541,43686673,30586083,12708478,41366938,30551199,55330649,24671709,50769840]
ablum_ids2 = [37081450,38160002,3150142,69266385,4482696,3888524,71664971,34390396,10331475,15828621,26440948,56206086,26531912,32210809,18476802,43287469,56603093,14356532,32553758,22811437,4626667,3187354,68724415,54021377,13394295,49808826,61441347,70003682,16231839,5993267,32988180,12168585,21220962,45413470,20135114,55070037,54079657,24326317,24619805,64773709,47988992,40121646,24645711,27249251,17581384,27470361,13617430,30507472,6385855,14342570,40514512,26085992,57319414,31551897,26764269,15966734,7857292,49383449,26879772,51954188,51079380,51164000,75075442,18515643,49000942,2867229,48477739,24873849,2900377,31913994,24812634,36765062,57161773,71330983,18368568,71664957,48533763,70003692,21772103,39418598,64773598,20134108,53997432,11355630,4340601,7762217,61310701,40165136,37425148,49867801,6912514,18057491,18743094,19515398,10578860,72342875,16043229,55883598,2760075,40639352,15731972,3060587,16040970,51626147,2840825,35049212,46069714,40634891,47956551,3644286,43687206,69706670]


def main1(ablum_ids):
    csvFilename = '../data/main2.csv'
    with open(csvFilename, 'w', encoding='utf-8') as f:
        # 先写一个表头：名字，播放次数，留存率1，留存率2，留存率3，留存率4
        f.write('name,playtimes,retention_rate1,retention_rate2,retention_rate3,retention_rate4\n')
        for albumId in ablum_ids:
            title, playtimes = getAlbumInfo(albumId)
            print(title, playtimes)
            retention_rates = getAlbumRetentionRate(albumId, step=100, count=4)
            print(retention_rates)
            # 写入csv文件
            f.write('{},{},{},{},{},{}\n'.format(title, playtimes, retention_rates[0], retention_rates[1], retention_rates[2], retention_rates[3]))
            # 缓存写入
            f.flush()



if __name__ == "__main__":
    ablum_ids = ablum_ids1 + ablum_ids2
    main1(ablum_ids)